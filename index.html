<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Worksheet Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #000000;
            --secondary: #474747;
            --input-bg-color: #d3d3d3; 
            --navy: #061E29;
        }

        body {
            background-color: #f8fafc;
            color: #000000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .heading-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .text-navy { color: var(--navy); }
        .border-teal { border-color: var(--secondary); }
        .bg-cloud { background-color: var(--background); }

        #sidebar {
            width: 380px;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #e2e8f0;
            background: rgb(198, 198, 199);
            z-index: 20;
            flex-shrink: 0;
        }

        #preview-pane {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            overflow: auto;
            background-color: #959ba1;
            padding: 80px 20px 80px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            scroll-behavior: smooth;
            position: relative;
        }

        #zoom-controls {
            position: fixed;
            top: 20px;
            right: 40px;
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 8px 16px;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
        }

        /* Fixed Standard Letter Dimensions with 1 inch margin */
        .page-container {
            width: 8.5in;
            height: 11in; 
            background: white;
            padding: 1in; /* 1 Inch Margin */
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            flex-shrink: 0;
            box-sizing: border-box;
            transform-origin: top center;
            overflow: hidden; 
            overflow: visible; 
            margin-bottom: 40px; 
            display: flex;
            flex-direction: column;
            margin-left: auto;
            margin-right: auto;
        }

        /* Visual indicator for print boundary in preview */
        .page-container::after {
            content: "PRINT BOUNDARY";
            position: absolute; bottom: 0; left: 0; right: 0;
            border-bottom: 2px dashed #ef4444;
            color: #ef4444; font-size: 10px; font-weight: bold;
            text-align: right; padding: 2px 5px; pointer-events: none; opacity: 0.6;
        }

        .tab-btn {
            border:#000000;
            border-radius: 25px;
            border-width: 4px;
            padding: 8px 4px;
            font-weight: bold;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            font-size: 0.8rem;
        }
        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background-color: #ffffff;
        }

        @media print {
            @page {
                size: letter;
                margin: 0; 
            }
            #sidebar, #zoom-controls, .no-print { display: none !important; }
            #preview-pane { 
                padding: 0; 
                background: white; 
                overflow: visible; 
                height: auto; 
                display: block; 
            }
            .page-container { 
                transform: none !important; 
                margin: 0 !important; 
                box-shadow: none; 
                width: 8.5in; 
                height: 11in;
                padding: 1in; 
                page-break-after: always;
                page-break-inside: avoid;
                overflow: hidden;
            }
            body { overflow: visible; height: auto; }
            .page-container::after { display: none; }
            /* Hide Modal in Print */
            #printModal { display: none !important; }
        }

        .worksheet-title-display {
            color: black;
            border-bottom: 1px solid transparent; 
        }
        .worksheet-title-display:hover {
            background-color: rgba(0,0,0,0.03);
            cursor: text;
            border-radius: 4px;
        }
        .worksheet-title-display:focus {
            outline: none;
            border-bottom-color: var(--primary);
            background-color: rgba(0,0,0,0.03);
        }

        input[type="text"],
        input[type="number"],
        select {
            border-color: var(--input-border-color); 
            background-color: var(--input-bg-color); 
        }

        #sidebar label.flex.items-center.gap-2 {
            background-color: var(--input-bg-color);
        }

        .worksheet-grid {
            display: grid;
            width: 100%;
            column-gap: 1rem; 
            row-gap: 2rem;    
            align-content: start; 
            box-sizing: border-box;
            flex-grow: 1;
        }

        .problem-card {
            padding: 0.1rem;
            position: relative;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center; 
            overflow: visible; 
        }

        .math-stacked {
            display: inline-block;
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2em;
            line-height: 1.2;
        }

        .math-line { border-bottom: 2px solid black; margin-bottom: 0.2rem; width: 100%; }
        .answer-text { color: #b91c1c; font-weight: bold; text-decoration: underline; }

        input[type="checkbox"], input[type="radio"] { accent-color: var(--primary); }
        .header-line { border-bottom: 1.5px solid black; display: inline-block; vertical-align: bottom; }
        
        .zoom-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
            color: var(--primary);
            font-weight: bold;
        }
        .zoom-btn:hover { background: #f1f5f9; }

        .fraction {
            display: inline-flex;
            flex-direction: column;
            vertical-align: middle;
            text-align: center;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            margin: 0 0.2rem;
            font-size: 1em; 
        }
        .fraction .num { border-bottom: 2px solid black; padding: 0 2px; }
        .fraction .den { padding: 0 2px; }
        .mixed-number { display: inline-flex; align-items: center; font-size: 1em; }
        .format-subgroup { margin-left: 1.5rem; padding: 0.5rem; border-left: 2px solid #e2e8f0; margin-top: 0.25rem; font-size: 0.75rem; }
        
        /* New Styles for Operation Settings */
        .op-settings-panel {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: #f1f5f9;
            border-radius: 0.375rem;
            border-left: 3px solid var(--secondary);
            font-size: 0.8rem;
        }
        .op-settings-panel input, .op-settings-panel select {
            background-color: white;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen overflow-hidden">

    <aside id="sidebar" class="no-print p-6 flex flex-col w-full md:w-[380px] h-auto max-h-[35vh] md:max-h-full md:h-full overflow-y-auto border-b md:border-b-0 md:border-r border-gray-200 flex-shrink-0">
        <header class="mb-4 border-b-2 border-teal pb-4">
            <h1 class="text-2xl font-bold heading-primary">Worksheet Generator</h1>
        </header>

        <div class="flex border-b mb-6 no-print gap-1">
            <button onclick="switchMode('arithmetic')" id="tabArith" class="tab-btn active">Arithmetic</button>
            <button onclick="switchMode('numberSense')" id="tabSense" class="tab-btn">Number Sense</button>
            <button onclick="switchMode('order')" id="tabOrder" class="tab-btn">Order of Ops</button>
        </div>

        <div class="space-y-6 flex-1 text-sm">
            <section>
                <h2 class="font-bold heading-primary mb-2">Worksheet Title</h2>
                <input type="text" id="customTitleInput" placeholder="Enter title" 
                       class="w-full p-2 rounded border border-gray-300" 
                       oninput="syncTitle()">
            </section>

            <!-- ================= NUMBER SENSE CONTROLS ================= -->
            <div id="numberSenseControls" class="hidden space-y-6">
                 <!-- Module Selection -->
                 <div class="mb-4">
                     <p class="font-bold mb-2">Select Skill Module</p>
                     <select id="senseModule" class="w-full p-2 rounded border border-gray-300" onchange="updateNumberSenseUI()">
                         <option value="compare">Comparing & Ordering</option>
                         <option value="forms">Place Value & Forms</option>
                         <option value="rounding">Rounding</option>
                         <option value="patterns">Patterns & Powers of 10</option>
                     </select>
                 </div>

                 <!-- MODULE: Comparing & Ordering -->
                 <div id="mod_compare" class="space-y-4">
                    <div class="bg-white rounded border border-gray-200 p-3">
                         <p class="font-bold text-navy mb-2">Task Type</p>
                         <div class="flex flex-col gap-2 mb-3">
                             <div class="flex gap-4">
                                 <label class="flex items-center gap-2"><input type="radio" name="compType" value="compare" checked onchange="toggleOrderSettings(); updatePreview()"> Compare (>, <, =)</label>
                                 <label class="flex items-center gap-2"><input type="radio" name="compType" value="order" onchange="toggleOrderSettings(); updatePreview()"> Order List</label>
                             </div>
                             <!-- NEW ORDER DIRECTION SETTINGS -->
                             <div id="orderSettings" class="hidden pl-6 mt-1 space-y-1 border-l-2 border-gray-300">
                                 <label class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase mb-1">Direction</label>
                                 <label class="flex items-center gap-2 text-sm"><input type="radio" name="orderDir" value="asc" checked onchange="updatePreview()"> Least to Greatest</label>
                                 <label class="flex items-center gap-2 text-sm"><input type="radio" name="orderDir" value="desc" onchange="updatePreview()"> Greatest to Least</label>
                             </div>
                         </div>
                         
                         <p class="font-bold text-navy mb-2 mt-4">Number Types</p>
                         <div class="space-y-2">
                             <label class="flex items-center gap-2"><input type="checkbox" id="ns_comp_int" checked onchange="updatePreview()"> Whole Numbers</label>
                             
                             <!-- Granular Decimal Controls -->
                             <div class="pl-2 border-l-2 border-gray-200 py-1 bg-gray-50 rounded-r">
                                 <p class="text-xs font-bold text-gray-500 mb-1">Decimals</p>
                                 <div class="grid grid-cols-2 gap-2">
                                     <label class="flex items-center gap-1 text-xs"><input type="checkbox" id="ns_comp_dec_1" onchange="updatePreview()"> Tenths</label>
                                     <label class="flex items-center gap-1 text-xs"><input type="checkbox" id="ns_comp_dec_2" onchange="updatePreview()"> Hundredths</label>
                                     <label class="flex items-center gap-1 text-xs"><input type="checkbox" id="ns_comp_dec_3" onchange="updatePreview()"> Thousandths</label>
                                 </div>
                             </div>

                             <label class="flex items-center gap-2"><input type="checkbox" id="ns_comp_neg" onchange="updatePreview()"> Negatives (Integers)</label>
                             <label class="flex items-center gap-2 border-t pt-2 mt-2"><input type="checkbox" id="ns_comp_abs" onchange="updatePreview()"> Include Absolute Value (|x|)</label>
                         </div>

                         <!-- NEW: Digit & Range Controls -->
                         <div class="mt-3 border-t pt-3">
                            <p class="font-bold text-navy mb-2 text-xs uppercase">Complexity</p>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label>Max Digits</label>
                                    <input type="number" id="ns_comp_max_digits" value="3" min="1" max="9" class="w-full border rounded p-1" onchange="updatePreview()">
                                </div>
                                <div id="ns_comp_count_wrapper" class="hidden">
                                    <label>Items to Order</label>
                                    <input type="number" id="ns_comp_count" value="4" min="3" max="8" class="w-full border rounded p-1" onchange="updatePreview()">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label>Min Val</label><input type="number" id="ns_comp_min" placeholder="0" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                                <div><label>Max Val</label><input type="number" id="ns_comp_max" placeholder="Auto" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                            </div>
                        </div>
                    </div>
                 </div>

                 <!-- MODULE: Place Value & Forms -->
                 <div id="mod_forms" class="hidden space-y-4">
                     <div class="bg-white rounded border border-gray-200 p-3">
                         <p class="font-bold text-navy mb-2">Conversion Task</p>
                         <select id="formTask" class="w-full p-2 rounded border mb-3" onchange="updatePreview()">
                             <option value="expanded">Standard to Expanded Form</option>
                             <option value="standard">Expanded to Standard Form</option>
                             <option value="underline">Value of Underlined Digit</option>
                         </select>

                         <div class="mt-3 border-t pt-3">
                            <p class="font-bold text-navy mb-2 text-xs uppercase">Range Settings</p>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <!-- UPDATED: Removed value="100" and value="999" to allow dynamic Max Digits logic -->
                                <div><label>Max Digits</label><input type="number" id="ns_form_max_digits" value="3" min="1" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                                <div><label>Min</label><input type="number" id="ns_form_min" placeholder="Auto" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                                <div><label>Max</label><input type="number" id="ns_form_max" placeholder="Auto" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                            </div>
                        </div>
                     </div>
                 </div>

                 <!-- MODULE: Rounding -->
                 <div id="mod_rounding" class="hidden space-y-4">
                    <div class="bg-white rounded border border-gray-200 p-3">
                        <p class="font-bold text-navy mb-2">Target Place Value</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2"><input type="radio" name="roundTarget" value="10" checked onchange="updatePreview()"> Nearest 10</label>
                            <label class="flex items-center gap-2"><input type="radio" name="roundTarget" value="100" onchange="updatePreview()"> Nearest 100</label>
                            <label class="flex items-center gap-2"><input type="radio" name="roundTarget" value="1000" onchange="updatePreview()"> Nearest 1,000</label>
                            <label class="flex items-center gap-2"><input type="radio" name="roundTarget" value="1" onchange="updatePreview()"> Nearest Whole (Decimal)</label>
                            <label class="flex items-center gap-2"><input type="radio" name="roundTarget" value="0.1" onchange="updatePreview()"> Nearest Tenth</label>
                        </div>

                        <!-- NEW: Digit & Range Controls -->
                        <div class="mt-3 border-t pt-3">
                            <p class="font-bold text-navy mb-2 text-xs uppercase">Number Range</p>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div><label>Digits</label><input type="number" id="ns_round_digits" value="3" min="1" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                                <div><label>Min</label><input type="number" id="ns_round_min" placeholder="Auto" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                                <div><label>Max</label><input type="number" id="ns_round_max" placeholder="Auto" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                            </div>
                        </div>
                    </div>
                 </div>

                 <!-- MODULE: Patterns & Powers of 10 -->
                 <div id="mod_patterns" class="hidden space-y-4">
                    <div class="bg-white rounded border border-gray-200 p-3">
                        <p class="font-bold text-navy mb-2">Skill</p>
                        <select id="patSkill" class="w-full p-2 rounded border mb-3" onchange="updateNumberSenseUI(); updatePreview()">
                            <option value="skip">Skip Counting</option>
                            <option value="powers">Powers of 10 Ops</option>
                        </select>

                        <div id="sub_skip">
                             <label>Count By:</label>
                             <select id="skipCountBy" class="w-full border rounded p-1 mb-2" onchange="updatePreview()">
                                 <option value="2">2s</option>
                                 <option value="5">5s</option>
                                 <option value="10">10s</option>
                                 <option value="100">100s</option>
                                 <option value="random">Random (2-10)</option>
                             </select>
                             <div class="grid grid-cols-2 gap-2">
                                <div><label>Start Min</label><input type="number" id="skipMin" value="0" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                                <div><label>Start Max</label><input type="number" id="skipMax" value="100" class="w-full border rounded p-1" onchange="updatePreview()"></div>
                            </div>
                        </div>

                        <div id="sub_powers" class="hidden">
                            <div class="space-y-2">
                                <label class="flex items-center gap-2"><input type="checkbox" id="pow_mult" checked onchange="updatePreview()"> Multiply</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="pow_div" onchange="updatePreview()"> Divide</label>
                                <label class="flex items-center gap-2 border-t pt-2 mt-2 font-bold"><input type="checkbox" id="pow_exp" onchange="updatePreview()"> Use Exponents (10³)</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="pow_dec" checked onchange="updatePreview()"> Include Decimals</label>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- ================= ARITHMETIC CONTROLS ================= -->
            <div id="arithmeticControls" class="space-y-6">
                
                 <!-- Distribution Controls -->
                <div class="mb-3 pb-3 border-b border-gray-200">
                    <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">Distribution</p>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer text-xs">
                            <input type="radio" name="opDist" value="mixed" checked onchange="updatePreview()"> Mix Randomly
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer text-xs">
                            <input type="radio" name="opDist" value="grouped" onchange="updatePreview()"> Group by Type
                        </label>
                    </div>
                </div>

                <section>
                    <h2 class="font-bold heading-primary mb-2">Operations & Logic</h2>
                    
                    <label class="flex items-center gap-2 p-2 mt-2 rounded bg-teal-100 cursor-pointer mb-4">
                        <input type="checkbox" id="modeFractions"> <strong>Enable Fractions Module</strong>
                    </label>

                    <div id="opContainer" class="space-y-3">
                        <!-- ADDITION -->
                        <div class="bg-white rounded border border-gray-200 p-2">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-navy">
                                <input type="checkbox" name="ops" value="addition" checked onchange="toggleOpSettings(this)"> Addition
                            </label>
                            <div id="settings_addition" class="op-settings-panel">
                                <div class="flex justify-between items-center mb-2">
                                   <label class="text-xs font-bold uppercase text-gray-500">Digit Settings</label>
                                   <label class="flex items-center gap-1 text-xs cursor-pointer text-navy font-bold">
                                       <input type="checkbox" id="addition_useMaxDigits" onchange="toggleDigitLabels('addition')"> Vary Length (Max)
                                   </label>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label id="addition_lblTop" class="text-xs">Fixed Top</label><input type="number" id="addition_digitsTop" value="2" min="1" class="w-full border rounded p-1"></div>
                                    <div><label id="addition_lblBot" class="text-xs">Fixed Bot</label><input type="number" id="addition_digitsBottom" value="2" min="1" class="w-full border rounded p-1"></div>
                                </div>
                                <!-- NEW: Max Sum Control for Addition -->
                                <div class="mb-2">
                                    <label class="text-xs">Max Result (Sum)</label>
                                    <input type="number" id="addition_maxResult" placeholder="e.g. 20 (No Limit)" class="w-full border rounded p-1">
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label>Min</label><input type="number" id="addition_rangeMin" placeholder="Auto" class="w-full border rounded p-1"></div>
                                    <div><label>Max</label><input type="number" id="addition_rangeMax" placeholder="Auto" class="w-full border rounded p-1"></div>
                                </div>
                                <select id="addition_numType" class="w-full border rounded p-1" onchange="togglePrecision('addition')">
                                    <option value="integers">Integers</option>
                                    <option value="decimals">Decimals</option>
                                </select>
                                <select id="addition_precision" class="w-full border rounded p-1 mt-1 hidden">
                                    <option value="1">Tenths</option>
                                    <option value="2">Hundredths</option>
                                    <option value="3">Thousandths</option>
                                </select>
                            </div>
                        </div>

                        <!-- SUBTRACTION -->
                        <div class="bg-white rounded border border-gray-200 p-2">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-navy">
                                <input type="checkbox" name="ops" value="subtraction" onchange="toggleOpSettings(this)"> Subtraction
                            </label>
                            <div id="settings_subtraction" class="op-settings-panel hidden">
                                <div class="flex justify-between items-center mb-2">
                                   <label class="text-xs font-bold uppercase text-gray-500">Digit Settings</label>
                                   <label class="flex items-center gap-1 text-xs cursor-pointer text-navy font-bold">
                                       <input type="checkbox" id="subtraction_useMaxDigits" onchange="toggleDigitLabels('subtraction')"> Vary Length (Max)
                                   </label>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label id="subtraction_lblTop" class="text-xs">Fixed Top</label><input type="number" id="subtraction_digitsTop" value="2" min="1" class="w-full border rounded p-1"></div>
                                    <div><label id="subtraction_lblBot" class="text-xs">Fixed Bot</label><input type="number" id="subtraction_digitsBottom" value="2" min="1" class="w-full border rounded p-1"></div>
                                </div>
                                <!-- NEW: Max Start Value Control for Subtraction -->
                                <div class="mb-2">
                                    <label class="text-xs">Max Start Value</label>
                                    <input type="number" id="subtraction_maxResult" placeholder="e.g. 20 (No Limit)" class="w-full border rounded p-1">
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label>Min</label><input type="number" id="subtraction_rangeMin" placeholder="Auto" class="w-full border rounded p-1"></div>
                                    <div><label>Max</label><input type="number" id="subtraction_rangeMax" placeholder="Auto" class="w-full border rounded p-1"></div>
                                </div>
                                <select id="subtraction_numType" class="w-full border rounded p-1" onchange="togglePrecision('subtraction')">
                                    <option value="integers">Integers</option>
                                    <option value="decimals">Decimals</option>
                                </select>
                                <select id="subtraction_precision" class="w-full border rounded p-1 mt-1 hidden">
                                    <option value="1">Tenths</option>
                                    <option value="2">Hundredths</option>
                                    <option value="3">Thousandths</option>
                                </select>
                            </div>
                        </div>

                         <!-- MULTIPLICATION -->
                         <div class="bg-white rounded border border-gray-200 p-2">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-navy">
                                <input type="checkbox" name="ops" value="multiplication" onchange="toggleOpSettings(this)"> Multiplication
                            </label>
                            <div id="settings_multiplication" class="op-settings-panel hidden">
                                <div class="flex justify-between items-center mb-2">
                                   <label class="text-xs font-bold uppercase text-gray-500">Digit Settings</label>
                                   <label class="flex items-center gap-1 text-xs cursor-pointer text-navy font-bold">
                                       <input type="checkbox" id="multiplication_useMaxDigits" onchange="toggleDigitLabels('multiplication')"> Vary Length (Max)
                                   </label>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label id="multiplication_lblTop" class="text-xs">Fixed Top</label><input type="number" id="multiplication_digitsTop" value="2" min="1" class="w-full border rounded p-1"></div>
                                    <div><label id="multiplication_lblBot" class="text-xs">Fixed Bot</label><input type="number" id="multiplication_digitsBottom" value="1" min="1" class="w-full border rounded p-1"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label>Min</label><input type="number" id="multiplication_rangeMin" placeholder="Auto" class="w-full border rounded p-1"></div>
                                    <div><label>Max</label><input type="number" id="multiplication_rangeMax" placeholder="Auto" class="w-full border rounded p-1"></div>
                                </div>
                                <select id="multiplication_numType" class="w-full border rounded p-1" onchange="togglePrecision('multiplication')">
                                    <option value="integers">Integers</option>
                                    <option value="decimals">Decimals</option>
                                </select>
                                <select id="multiplication_precision" class="w-full border rounded p-1 mt-1 hidden">
                                    <option value="1">Tenths</option>
                                    <option value="2">Hundredths</option>
                                    <option value="3">Thousandths</option>
                                </select>
                            </div>
                        </div>

                         <!-- DIVISION -->
                         <div class="bg-white rounded border border-gray-200 p-2">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-navy">
                                <input type="checkbox" name="ops" value="division" onchange="toggleOpSettings(this)"> Division
                            </label>
                            <div id="settings_division" class="op-settings-panel hidden">
                                <div class="flex justify-between items-center mb-2">
                                   <label class="text-xs font-bold uppercase text-gray-500">Digit Settings</label>
                                   <label class="flex items-center gap-1 text-xs cursor-pointer text-navy font-bold">
                                       <input type="checkbox" id="division_useMaxDigits" onchange="toggleDigitLabels('division')"> Vary Length (Max)
                                   </label>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label id="division_lblTop" class="text-xs">Fixed Top</label><input type="number" id="division_digitsTop" value="2" min="1" class="w-full border rounded p-1"></div>
                                    <div><label id="division_lblBot" class="text-xs">Fixed Bot</label><input type="number" id="division_digitsBottom" value="1" min="1" class="w-full border rounded p-1"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label>Min</label><input type="number" id="division_rangeMin" placeholder="Auto" class="w-full border rounded p-1"></div>
                                    <div><label>Max</label><input type="number" id="division_rangeMax" placeholder="Auto" class="w-full border rounded p-1"></div>
                                </div>
                                <select id="division_numType" class="w-full border rounded p-1" onchange="togglePrecision('division')">
                                    <option value="integers">Integers</option>
                                    <option value="decimals">Decimals</option>
                                </select>
                                <select id="division_precision" class="w-full border rounded p-1 mt-1 hidden">
                                    <option value="1">Tenths</option>
                                    <option value="2">Hundredths</option>
                                    <option value="3">Thousandths</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Fraction Module -->
                <section id="fractionSettings" class="hidden p-3 border-2 border-teal rounded bg-teal-50 space-y-4">
                    <h3 class="font-bold text-navy border-b border-teal pb-1">Fractions Module</h3>
                    
                    <div>
                        <p class="text-[10px] font-bold uppercase text-gray-500 mb-1">Denominators</p>
                        <div class="space-y-1">
                            <label class="flex items-center gap-2"><input type="radio" name="denType" value="benchmarks" checked> Benchmarks</label>
                            <label class="flex items-center gap-2"><input type="radio" name="denType" value="within20"> Within 20</label>
                            <label class="flex items-center gap-2"><input type="radio" name="denType" value="within100"> Within 100</label>
                            <div class="flex items-center gap-2">
                                <input type="radio" name="denType" value="custom"> 
                                <input type="text" id="customDens" placeholder="e.g. 7, 12, 15" class="w-full p-1 border rounded text-xs">
                            </div>
                        </div>
                    </div>

                    <div>
                        <p class="text-[10px] font-bold uppercase text-gray-500 mb-1">Terms</p>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="termType" value="common" checked> Common</label>
                            <label class="flex items-center gap-2"><input type="radio" name="termType" value="uncommon"> Uncommon</label>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <p class="text-[10px] font-bold uppercase text-gray-500">Formats</p>
                        <div class="space-y-1">
                            <label class="flex items-center gap-2"><input type="checkbox" id="fmtWhole"> Whole Numbers</label>
                            <div id="wholeOptions" class="format-subgroup hidden">
                                <label class="flex items-center gap-2"><input type="radio" name="wholeScope" value="first" checked> First Term</label>
                                <label class="flex items-center gap-2"><input type="radio" name="wholeScope" value="second"> Second Term</label>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="flex items-center gap-2"><input type="checkbox" id="fmtImproper"> Improper Fractions</label>
                            <div id="improperOptions" class="format-subgroup hidden">
                                <label class="flex items-center gap-2"><input type="radio" name="impScope" value="first" checked> First Term</label>
                                <label class="flex items-center gap-2"><input type="radio" name="impScope" value="second"> Second Term</label>
                                <label class="flex items-center gap-2"><input type="radio" name="impScope" value="both"> Both Terms</label>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="flex items-center gap-2"><input type="checkbox" id="fmtMixed"> Mixed Numbers</label>
                            <div id="mixedOptions" class="format-subgroup hidden">
                                <label class="flex items-center gap-2"><input type="radio" name="mixScope" value="first" checked> First Term</label>
                                <label class="flex items-center gap-2"><input type="radio" name="mixScope" value="second"> Second Term</label>
                                <label class="flex items-center gap-2"><input type="radio" name="mixScope" value="both"> Both Terms</label>
                            </div>
                        </div>
                    </div>
                </section>


                <!-- Layout & Style -->
                <section>
                    <h2 class="font-bold heading-primary mb-2">Layout & Style</h2>
                    <div class="space-y-2">
                        <select id="layoutStyle" class="w-full p-2 rounded border border-gray-300">
                            <option value="stacked">Vertical (Stacked)</option>
                            <option value="horizontal">Horizontal (Equations)</option>
                        </select>
                        <div class="grid grid-cols-1 gap-1">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="modeMissing"> Missing Numbers</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="modeRemainders"> Include Remainders (Div)</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="modeWord"> Word Problems</label>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ================= ORDER OF OPERATIONS CONTROLS ================= -->
            <div id="orderControls" class="hidden space-y-6">
                <section>
                    <h2 class="font-bold heading-primary mb-2">Structure</h2>
                    <div class="bg-cloud p-3 rounded space-y-3">
                        <div class="flex items-center justify-between">
                            <span>Terms</span>
                            <input type="number" id="termCount" value="3" min="2" max="6" class="w-16 p-1 rounded border">
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Max Value</span>
                            <input type="number" id="maxValue" value="12" min="1" max="100" class="w-16 p-1 rounded border">
                        </div>
                        <div>
                            <p class="font-bold mb-2">Operations</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2"><input type="checkbox" name="orderOps" value="+" checked> +</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="orderOps" value="-" checked> -</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="orderOps" value="×" checked> ×</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="orderOps" value="÷"> ÷</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-bold mb-2">Distributive Property</p>
                            <select id="distMode" class="w-full p-1 border rounded">
                                <option value="none">None</option>
                                <option value="mixed">Mixed</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="font-bold heading-primary mb-2">Variables & Extras</h2>
                    <div class="bg-cloud p-3 rounded space-y-3">
                        <div class="grid grid-cols-1 gap-2">
                            <label class="flex items-center gap-2 p-2 rounded bg-white cursor-pointer text-xs">
                                <input type="checkbox" id="includeX"> Include Variable (x)
                            </label>
                            <label class="flex items-center gap-2 p-2 rounded bg-white cursor-pointer text-xs">
                                <input type="checkbox" id="includeX2"> Include Variable (x²)
                            </label>
                        </div>
                        <div class="border-t border-teal pt-2 mt-2">
                            <label class="flex items-center gap-2 p-2 rounded bg-white cursor-pointer text-xs mb-2">
                                <input type="checkbox" id="orderFractions"> Include Basic Fractions
                            </label>
                            <label class="flex items-center gap-2 p-2 rounded bg-white cursor-pointer text-xs mb-2">
                                <input type="checkbox" id="allowNeg" checked> Allow Negative Results
                            </label>
                            <div>
                                <p class="font-bold mb-1 text-xs">Substitution Mode</p>
                                <select id="substMode" class="w-full p-1 border rounded text-xs">
                                    <option value="none">None</option>
                                    <option value="global">Page-Wide (Single x)</option>
                                    <option value="individual">Individual (Per Problem)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Global Output Settings -->
            <section>
                <h2 class="font-bold heading-primary mb-2">Output Settings</h2>
                <div class="space-y-2">
                    <div class="flex items-center justify-between bg-cloud p-3 rounded">
                        <span>Page Count</span>
                        <input type="number" id="pageQuantity" value="1" min="1" max="25" class="w-16 p-1 rounded border">
                    </div>
                    <div class="flex items-center justify-between bg-cloud p-3 rounded">
                        <span>Problems Per Page</span>
                        <input type="number" id="quantity" value="12" min="1" max="40" class="w-16 p-1 rounded border">
                    </div>
                    <label class="mt-3 flex items-center gap-2 cursor-pointer font-bold text-navy">
                        <input type="checkbox" id="includeKey" checked> Generate Answer Key
                    </label>
                </div>
            </section>
        </div>

        <div class="mt-6 pt-6 border-t space-y-2">
            <button onclick="updatePreview()" class="w-full py-3 bg-primary text-white font-bold rounded hover:opacity-90 transition uppercase tracking-wide">Generate</button>
            <button onclick="openPrintModal()" class="w-full py-3 border-2 border-teal text-navy font-bold rounded hover:bg-gray-50 transition">Print</button>
        </div>
    </aside>

    <main id="preview-pane" class="flex-1 h-full overflow-y-auto relative scroll-smooth">
        <div id="zoom-controls" class="no-print">
            <button onclick="changeZoom(-0.1)" class="zoom-btn" title="Zoom Out"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
            <span id="zoom-level" class="text-sm font-bold w-12 text-center text-navy">100%</span>
            <button onclick="changeZoom(0.1)" class="zoom-btn" title="Zoom In"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
            <button onclick="resetZoom()" class="text-xs text-gray-400 hover:text-primary underline ml-2">Reset</button>
        </div>
        <div id="page-wrapper" class="flex flex-col items-center gap-10 w-full"></div>
    </main>

    <!-- PRINT CONFIRMATION MODAL -->
    <div id="printModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100] no-print backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border border-gray-200">
            <h3 class="text-xl font-bold mb-4 heading-primary">Check Worksheet Title</h3>
            <div class="bg-gray-100 p-4 rounded mb-4">
                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Current Title</p>
                <p id="printTitlePreview" class="font-serif text-lg font-bold text-black border-l-4 border-red-700 pl-3"></p>
            </div>
            <p class="mb-6 text-sm text-gray-600">Please verify the title is correct before printing. You can edit it in the sidebar.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closePrintModal()" class="px-4 py-2 border rounded hover:bg-gray-50 font-bold text-gray-600">Cancel</button>
                <button onclick="finalizePrint()" class="px-4 py-2 bg-primary text-white font-bold rounded hover:opacity-90 shadow-md">Yes, Print</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'arithmetic';
        let currentZoom = 1.0;

        const ui = {
            previewPane: document.getElementById('preview-pane'),
            pageWrapper: document.getElementById('page-wrapper'),
            titleInput: document.getElementById('customTitleInput'),
            modeFractions: document.getElementById('modeFractions'),
            fracSettings: document.getElementById('fractionSettings'),
            opContainer: document.getElementById('opContainer'), 
            arithControls: document.getElementById('arithmeticControls'),
            orderControls: document.getElementById('orderControls'),
            senseControls: document.getElementById('numberSenseControls'),
            tabArith: document.getElementById('tabArith'),
            tabOrder: document.getElementById('tabOrder'),
            tabSense: document.getElementById('tabSense'),
            zoomLevel: document.getElementById('zoom-level'),
            // Toggles
            fmtWhole: document.getElementById('fmtWhole'),
            wholeOptions: document.getElementById('wholeOptions'),
            fmtImproper: document.getElementById('fmtImproper'),
            improperOptions: document.getElementById('improperOptions'),
            fmtMixed: document.getElementById('fmtMixed'),
            mixedOptions: document.getElementById('mixedOptions'),
            // Modal
            printModal: document.getElementById('printModal'),
            printTitlePreview: document.getElementById('printTitlePreview')
        };

        // UI Event Listeners
        function switchMode(mode) {
            currentMode = mode;
            ui.tabArith.classList.toggle('active', mode === 'arithmetic');
            ui.tabOrder.classList.toggle('active', mode === 'order');
            ui.tabSense.classList.toggle('active', mode === 'numberSense');
            
            ui.arithControls.classList.toggle('hidden', mode !== 'arithmetic');
            ui.orderControls.classList.toggle('hidden', mode !== 'order');
            ui.senseControls.classList.toggle('hidden', mode !== 'numberSense');
        }

        ui.modeFractions.addEventListener('change', (e) => {
            const isFrac = e.target.checked;
            ui.fracSettings.classList.toggle('hidden', !isFrac);
            
            // Toggle visibility of internal settings panels only, keeping checkboxes visible
            const panels = document.querySelectorAll('.op-settings-panel');
            if (isFrac) {
                panels.forEach(p => p.classList.add('hidden'));
            } else {
                // Restore visibility for checked operations
                document.querySelectorAll('input[name="ops"]').forEach(cb => {
                    const panel = document.getElementById(`settings_${cb.value}`);
                    if (panel) {
                        if (cb.checked) panel.classList.remove('hidden');
                        else panel.classList.add('hidden');
                    }
                });
            }
            updatePreview();
        });

        ui.fmtWhole.addEventListener('change', (e) => ui.wholeOptions.classList.toggle('hidden', !e.target.checked));
        ui.fmtImproper.addEventListener('change', (e) => ui.improperOptions.classList.toggle('hidden', !e.target.checked));
        ui.fmtMixed.addEventListener('change', (e) => ui.mixedOptions.classList.toggle('hidden', !e.target.checked));
        
        function toggleOpSettings(checkbox) {
            // If in fractions mode, we don't show the integer settings panel
            if (ui.modeFractions.checked) {
                updatePreview();
                return;
            }

            const panel = document.getElementById(`settings_${checkbox.value}`);
            if (panel) {
                if (checkbox.checked) panel.classList.remove('hidden');
                else panel.classList.add('hidden');
            }
            updatePreview();
        }

        function togglePrecision(op) {
            const type = document.getElementById(`${op}_numType`).value;
            const prec = document.getElementById(`${op}_precision`);
            if (type === 'decimals') prec.classList.remove('hidden');
            else prec.classList.add('hidden');
        }

        // NEW: Toggle Order Settings visibility
        function toggleOrderSettings() {
            const isOrder = document.querySelector('input[name="compType"][value="order"]').checked;
            const settings = document.getElementById('orderSettings');
            const countWrapper = document.getElementById('ns_comp_count_wrapper');
            if (settings) settings.classList.toggle('hidden', !isOrder);
            if (countWrapper) countWrapper.classList.toggle('hidden', !isOrder);
        }

        // NEW: Toggle Arithmetic Digit Labels
        function toggleDigitLabels(op) {
            const isMax = document.getElementById(`${op}_useMaxDigits`).checked;
            document.getElementById(`${op}_lblTop`).textContent = isMax ? "Max Top Digits" : "Fixed Top Digits";
            document.getElementById(`${op}_lblBot`).textContent = isMax ? "Max Bot Digits" : "Fixed Bot Digits";
            updatePreview();
        }

        function updateNumberSenseUI() {
            const mod = document.getElementById('senseModule').value;
            ['mod_compare', 'mod_forms', 'mod_rounding', 'mod_patterns'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(`mod_${mod}`).classList.remove('hidden');

            // Sub-modules
            if(mod === 'patterns') {
                const patSkill = document.getElementById('patSkill').value;
                document.getElementById('sub_skip').classList.toggle('hidden', patSkill !== 'skip');
                document.getElementById('sub_powers').classList.toggle('hidden', patSkill !== 'powers');
            }
        }
        
        document.querySelectorAll('.op-settings-panel input, .op-settings-panel select').forEach(el => {
            el.addEventListener('change', updatePreview);
            el.addEventListener('input', updatePreview);
        });

        // MODAL FUNCTIONS
        function openPrintModal() {
            ui.printTitlePreview.textContent = ui.titleInput.value || "Mathematics Assessment";
            ui.printModal.classList.remove('hidden');
        }

        function closePrintModal() {
            ui.printModal.classList.add('hidden');
        }

        function finalizePrint() {
            closePrintModal();
            window.print();
        }

        function changeZoom(delta) {
            currentZoom = Math.min(Math.max(0.4, currentZoom + delta), 2.0);
            applyZoom();
        }
        function resetZoom() { currentZoom = 1.0; applyZoom(); }
        
        function applyZoom() {
            ui.zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
            document.querySelectorAll('.page-container').forEach(page => {
                page.style.transform = `scale(${currentZoom})`;
                const pageHeightPx = 1056; 
                const margin = (pageHeightPx * (currentZoom - 1)) + 40;
                page.style.marginBottom = `${margin}px`;
            });
        }
        function syncTitle() {
            const title = ui.titleInput.value || "Mathematics Assessment";
            document.querySelectorAll('.worksheet-title-display').forEach(el => {
                const isKey = el.getAttribute('data-is-key') === 'true';
                el.textContent = (isKey ? "Answer Key - " : "") + title;
            });
        }

        // Logic Helpers
        function gcd(a, b) { return b ? gcd(b, a % b) : a; }
        function simplify(n, d) { const common = gcd(n, d); return [n / common, d / common]; }
        
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Generalized Value Generator
        function generateValue(digits, userMin, userMax, isDecimal, precision) {
            const digitMin = Math.pow(10, digits - 1);
            const digitMax = Math.pow(10, digits) - 1;
            const finalMin = userMin !== "" ? Math.max(digitMin, parseFloat(userMin)) : digitMin;
            const finalMax = userMax !== "" ? Math.min(digitMax, parseFloat(userMax)) : digitMax;

            if (finalMin > finalMax) {
                const fallbackMin = userMin !== "" ? parseFloat(userMin) : digitMin;
                const fallbackMax = userMax !== "" ? parseFloat(userMax) : digitMax;
                const val = Math.random() * (fallbackMax - fallbackMin) + fallbackMin;
                return isDecimal ? parseFloat(val.toFixed(parseInt(precision))) : Math.floor(val);
            }

            const val = Math.random() * (finalMax - finalMin) + finalMin;
            return isDecimal ? parseFloat(val.toFixed(parseInt(precision))) : Math.floor(val);
        }

        // NEW: Specialized Arithmetic Operand Generator supporting Fixed vs Max
        function generateArithmeticOperand(digits, useMax, userMin, userMax, isDecimal, precision) {
            // If user provides specific ranges, prioritize them
            if (userMin !== "" || userMax !== "") {
                return generateValue(digits, userMin, userMax, isDecimal, precision);
            }

            // If "Use Max Digits" (Vary Length) is ON
            if (useMax) {
                // Weighted selection: Pick a digit count from 1 to 'digits'
                const d = Math.floor(Math.random() * digits) + 1;
                // Generate based on that specific length 'd'
                const min = Math.pow(10, d - 1);
                const max = Math.pow(10, d) - 1;
                
                let val = Math.random() * (max - min + 1) + min;
                if (!isDecimal) val = Math.floor(val);
                else val = parseFloat(val.toFixed(parseInt(precision)));
                
                return val;
            } 
            
            // Standard Fixed Length Behavior
            return generateValue(digits, userMin, userMax, isDecimal, precision);
        }

        function getFractionsData() {
            const denType = document.querySelector('input[name="denType"]:checked').value;
            let dens = [2, 3, 4, 5, 8, 10];
            if (denType === 'within20') dens = Array.from({length: 19}, (_, i) => i + 2);
            else if (denType === 'within100') dens = Array.from({length: 99}, (_, i) => i + 2);
            else if (denType === 'custom') {
                const val = document.getElementById('customDens').value;
                if (val) dens = val.split(',').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
            }
            return {
                dens,
                termType: document.querySelector('input[name="termType"]:checked').value,
                whole: ui.fmtWhole.checked,
                wholeScope: document.querySelector('input[name="wholeScope"]:checked')?.value,
                improper: ui.fmtImproper.checked,
                impScope: document.querySelector('input[name="impScope"]:checked')?.value,
                mixed: ui.fmtMixed.checked,
                mixScope: document.querySelector('input[name="mixScope"]:checked')?.value
            };
        }

        function createFraction(isFirst, config) {
            const den = config.dens[Math.floor(Math.random() * config.dens.length)];
            const isWhole = config.whole && ((isFirst && config.wholeScope === 'first') || (!isFirst && config.wholeScope === 'second'));
            const isMixed = config.mixed && (config.mixScope === 'both' || (isFirst && config.mixScope === 'first') || (!isFirst && config.mixScope === 'second'));
            const isImproper = config.improper && (config.impScope === 'both' || (isFirst && config.impScope === 'first') || (!isFirst && config.impScope === 'second'));

            if (isWhole) return { whole: Math.floor(Math.random() * 9) + 2, num: 0, den: 1, type: 'whole' };
            
            let num;
            if (isMixed) {
                do { num = Math.floor(Math.random() * (den - 1)) + 1; } while (num % den === 0);
                return { whole: Math.floor(Math.random() * 4) + 1, num, den, type: 'mixed' };
            } else if (isImproper) {
                num = (Math.floor(Math.random() * (den - 1)) + 1) + den * (Math.floor(Math.random() * 2) + 1);
                return { whole: 0, num, den, type: 'improper' };
            } else {
                do { num = Math.floor(Math.random() * (den - 1)) + 1; } while (num % den === 0);
                return { whole: 0, num, den, type: 'proper' };
            }
        }

        function computeFractionAnswer(f1, f2, op) {
            const getImp = (f) => {
                if (f.type === 'whole') return { n: f.whole, d: 1 };
                const w = f.whole || 0;
                return { n: w * f.den + f.num, d: f.den };
            };
            const v1 = getImp(f1);
            const v2 = getImp(f2);
            let resN, resD;
            if (op === 'addition') {
                resN = v1.n * v2.d + v2.n * v1.d; resD = v1.d * v2.d;
            } else if (op === 'subtraction') {
                resN = v1.n * v2.d - v2.n * v1.d; resD = v1.d * v2.d;
            } else if (op === 'multiplication') {
                resN = v1.n * v2.n; resD = v1.d * v2.d;
            } else if (op === 'division') {
                resN = v1.n * v2.d; resD = v1.d * v2.n;
            }
            if (resD === 0) return "Undef";
            if (resN === 0) return "0";
            const [sN, sD] = simplify(Math.abs(resN), Math.abs(resD));
            const sign = (resN * resD < 0) ? "-" : "";
            if (sD === 1) return sign + sN;
            if (sN > sD) {
                const w = Math.floor(sN / sD);
                const rem = sN % sD;
                return rem === 0 ? sign + w : `${sign}${w} ${rem}/${sD}`;
            }
            return `${sign}${sN}/${sD}`;
        }

        // GENERATORS
        function createArithmeticProblem(op) {
            if (ui.modeFractions.checked) {
                const config = getFractionsData();
                let f1 = createFraction(true, config);
                let f2 = createFraction(false, config);
                if (f1.type !== 'whole' && f2.type !== 'whole' && config.termType === 'common') {
                    f2.den = f1.den;
                }
                const ans = computeFractionAnswer(f1, f2, op);
                return { f1, f2, op, type: 'fraction', answer: ans };
            } else {
                const isDec = document.getElementById(`${op}_numType`).value === 'decimals';
                const prec = document.getElementById(`${op}_precision`).value;
                const tD = parseInt(document.getElementById(`${op}_digitsTop`).value);
                const bD = parseInt(document.getElementById(`${op}_digitsBottom`).value);
                const rMin = document.getElementById(`${op}_rangeMin`).value;
                const rMax = document.getElementById(`${op}_rangeMax`).value;
                
                // NEW: Max Result / Max Start Value Logic
                let maxRes = "";
                if (op === 'addition') maxRes = document.getElementById('addition_maxResult').value;
                if (op === 'subtraction') maxRes = document.getElementById('subtraction_maxResult').value;

                // NEW: Check for Max Digits Mode
                const useMax = document.getElementById(`${op}_useMaxDigits`)?.checked || false;

                let n1, n2;
                
                // Logic for constrained sums (Addition)
                if (op === 'addition' && maxRes !== "") {
                    const limit = parseInt(maxRes);
                    // Generate n1 first
                    n1 = generateArithmeticOperand(tD, useMax, rMin, rMax, isDec, prec);
                    // Ensure n1 is within limit (if n1 > limit, cap it or retry? simpliest is cap)
                    if (n1 > limit) n1 = getRandomInt(1, limit); 
                    
                    // Generate n2 such that n1 + n2 <= limit
                    const remaining = limit - n1;
                    if (remaining < 0) { n1 = getRandomInt(1, limit); n2 = getRandomInt(1, limit - n1); } 
                    else {
                        // n2 must roughly match bD constraints but definitely be <= remaining
                        // We generate a candidate for n2 normally first
                        let candidateN2 = generateArithmeticOperand(bD, useMax, rMin, rMax, isDec, prec);
                        if (candidateN2 > remaining) {
                            // If generated n2 is too big, just pick random up to remaining
                            n2 = getRandomInt(1, remaining);
                        } else {
                            n2 = candidateN2;
                        }
                    }
                } 
                // Logic for constrained start value (Subtraction)
                else if (op === 'subtraction' && maxRes !== "") {
                    const limit = parseInt(maxRes);
                    // n1 (minuend) must be <= limit
                    n1 = generateArithmeticOperand(tD, useMax, rMin, rMax, isDec, prec);
                    if (n1 > limit) n1 = getRandomInt(1, limit);
                    
                    // n2 (subtrahend) must be <= n1
                    let candidateN2 = generateArithmeticOperand(bD, useMax, rMin, rMax, isDec, prec);
                    if (candidateN2 > n1) {
                        n2 = getRandomInt(1, n1);
                    } else {
                        n2 = candidateN2;
                    }
                }
                else {
                    // Standard Logic
                    n1 = generateArithmeticOperand(tD, useMax, rMin, rMax, isDec, prec);
                    n2 = generateArithmeticOperand(bD, useMax, rMin, rMax, isDec, prec);
                }

                if (op === 'subtraction' && n2 > n1) [n1, n2] = [n2, n1];
                if (op === 'division' && !document.getElementById('modeRemainders').checked) {
                    // For division without remainders, we generate quotient and divisor then multiply
                    // n1 (dividend) = n2 (divisor) * quotient
                    // Here, tD usually refers to the dividend length, but generating multiplication problems in reverse is cleaner
                    // Let's stick to standard generation: make n1 a multiple of n2
                    if(useMax) {
                         // Regenerate to ensure simple multiples don't blow out digit constraints too wildly
                         // Actually, sticking to the standard "multiply back" is safer
                         const q = getRandomInt(2, 12); // Simple quotient
                         n1 = n2 * q; 
                    } else {
                         n1 = n2 * getRandomInt(2, 12);
                    }
                }

                let ans;
                if (op === 'addition') ans = n1 + n2;
                else if (op === 'subtraction') ans = n1 - n2;
                else if (op === 'multiplication') ans = n1 * n2;
                else ans = n1 / n2;

                if(isDec) ans = parseFloat(ans.toFixed(parseInt(prec)));
                else if (op === 'division' && document.getElementById('modeRemainders').checked) {
                     ans = `${Math.floor(n1/n2)} R ${n1%n2}`;
                }

                return { n1, n2, op, type: 'standard', answer: ans };
            }
        }

        function generateNumberSenseProblem() {
            const module = document.getElementById('senseModule').value;
            
            if (module === 'compare') {
                const compType = document.querySelector('input[name="compType"]:checked').value;
                const useInt = document.getElementById('ns_comp_int').checked;
                
                // Granular Decimal Logic
                const useDec1 = document.getElementById('ns_comp_dec_1').checked;
                const useDec2 = document.getElementById('ns_comp_dec_2').checked;
                const useDec3 = document.getElementById('ns_comp_dec_3').checked;
                const activeDecimals = [];
                if (useDec1) activeDecimals.push(1);
                if (useDec2) activeDecimals.push(2);
                if (useDec3) activeDecimals.push(3);

                const useNeg = document.getElementById('ns_comp_neg').checked;
                const useAbs = document.getElementById('ns_comp_abs').checked;
                
                const maxDigits = parseInt(document.getElementById('ns_comp_max_digits').value) || 2;
                const rMin = document.getElementById('ns_comp_min').value;
                const rMax = document.getElementById('ns_comp_max').value;

                const types = [];
                if(useInt) types.push('int');
                if(activeDecimals.length > 0) types.push('dec');
                
                // Fallback
                if (types.length === 0) types.push('int');

                const getNum = () => {
                    const type = types[Math.floor(Math.random() * types.length)];
                    let val;
                    let precision = 0;

                    if(type === 'dec') {
                        precision = activeDecimals[Math.floor(Math.random() * activeDecimals.length)];
                        // For decimals, we typically want the standard distribution, but let's constrain the whole number part
                        // to ensure it doesn't blow out visually
                        val = generateValue(maxDigits, rMin, rMax, true, precision);
                    } else {
                        // Integer logic with Weighted Digit Selection
                        if (rMin === "" && rMax === "") {
                            // 1. Randomly pick a digit count (e.g., 1, 2, or 3)
                            const d = Math.floor(Math.random() * maxDigits) + 1;
                            // 2. Generate a number with exactly 'd' digits
                            const minD = Math.pow(10, d - 1);
                            const maxD = Math.pow(10, d) - 1;
                            val = Math.floor(Math.random() * (maxD - minD + 1)) + minD;
                        } else {
                            // User provided strict range, respect it
                            val = generateValue(maxDigits, rMin, rMax, false, 0);
                            if (!Number.isInteger(val)) val = Math.floor(val);
                        }
                    }
                    
                    if (useNeg && Math.random() > 0.5) val *= -1;
                    
                    return val;
                }

                if (compType === 'compare') {
                    let n1 = getNum();
                    let n2 = getNum();
                    let d1 = n1, d2 = n2;
                    let v1 = n1, v2 = n2;

                    if (useAbs) {
                        if (Math.random() > 0.6) { d1 = `|${n1}|`; v1 = Math.abs(n1); }
                        if (Math.random() > 0.6) { d2 = `|${n2}|`; v2 = Math.abs(n2); }
                    }

                    let ans = "=";
                    if(v1 > v2) ans = ">";
                    if(v1 < v2) ans = "<";
                    
                    return { type: 'ns_compare', d1, d2, ans };
                } else {
                    let count = parseInt(document.getElementById('ns_comp_count').value) || 4;
                    let nums = Array.from({length: count}, getNum);
                    let displayNums = nums.map(n => {
                         if(useAbs && Math.random() > 0.6) return { d: `|${n}|`, v: Math.abs(n) };
                         return { d: n, v: n };
                    });
                    
                    const dir = document.querySelector('input[name="orderDir"]:checked').value;
                    let sorted = [...displayNums].sort((a,b) => {
                         if(dir === 'asc') return a.v - b.v;
                         return b.v - a.v;
                    });
                    
                    let ans = sorted.map(i => i.d).join(', ');
                    
                    return { type: 'ns_order', items: displayNums.map(i => i.d), ans, dir };
                }
            }
            
            else if (module === 'forms') {
                const task = document.getElementById('formTask').value;
                const maxDigits = parseInt(document.getElementById('ns_form_max_digits').value) || 3;
                const rMinStr = document.getElementById('ns_form_min').value;
                const rMaxStr = document.getElementById('ns_form_max').value;
                
                let num;

                // Weighted Digit Logic for Forms
                if (rMinStr === "" && rMaxStr === "") {
                    // Equal chance for any number of digits up to max
                    const d = Math.floor(Math.random() * maxDigits) + 1;
                    const minD = Math.pow(10, d - 1);
                    const maxD = Math.pow(10, d) - 1;
                    num = Math.floor(Math.random() * (maxD - minD + 1)) + minD;
                } else {
                    // Explicit range provided
                    const limit = Math.pow(10, maxDigits) - 1;
                    let min = rMinStr !== "" ? parseInt(rMinStr) : 1;
                    let max = rMaxStr !== "" ? parseInt(rMaxStr) : limit;
                    
                    if (min > max) [min, max] = [max, min];
                    num = Math.floor(Math.random() * (max - min + 1)) + min;
                }

                if (task === 'expanded') {
                    const str = num.toString();
                    const parts = [];
                    for(let i=0; i<str.length; i++) {
                        const digit = parseInt(str[i]);
                        if(digit !== 0) parts.push(digit * Math.pow(10, str.length - 1 - i));
                    }
                    return { type: 'ns_forms', q: `${num}`, ans: parts.join(' + '), subType: 'toExpanded' };
                } else if (task === 'standard') {
                     const str = num.toString();
                    const parts = [];
                    for(let i=0; i<str.length; i++) {
                        const digit = parseInt(str[i]);
                        if(digit !== 0) parts.push(digit * Math.pow(10, str.length - 1 - i));
                    }
                    return { type: 'ns_forms', q: `${parts.join(' + ')}`, ans: num, subType: 'toStandard' };
                } else if (task === 'underline') {
                     const str = num.toString();
                     const idx = Math.floor(Math.random() * str.length);
                     const val = parseInt(str[idx]) * Math.pow(10, str.length - 1 - idx);
                     const formatted = str.substring(0, idx) + `<u>${str[idx]}</u>` + str.substring(idx+1);
                     return { type: 'ns_forms', q: `${formatted}`, ans: val, subType: 'underline' };
                }
            }
            
            else if (module === 'rounding') {
                const target = parseFloat(document.querySelector('input[name="roundTarget"]:checked').value);
                const digits = parseInt(document.getElementById('ns_round_digits').value) || 3;
                const rMin = document.getElementById('ns_round_min').value;
                const rMax = document.getElementById('ns_round_max').value;
                
                let num;
                
                if (target >= 1) {
                    num = generateValue(digits, rMin, rMax, false, 0);
                    if (num < target/2) num = getRandomInt(target/2, target*2);
                } else {
                     num = generateValue(digits, rMin, rMax, true, 3);
                }

                // Removed instructions from qText, now handled in Header
                // Calculating answer
                let factor = 1/target;
                let ans = Math.round(num * factor) / factor;

                return { type: 'ns_text', q: `${num}`, ans: ans };
            }
            
            else if (module === 'patterns') {
                const skill = document.getElementById('patSkill').value;
                if (skill === 'skip') {
                     let by = document.getElementById('skipCountBy').value;
                     if(by === 'random') by = getRandomInt(2, 10);
                     else by = parseInt(by);
                     
                     const start = getRandomInt(parseInt(document.getElementById('skipMin').value), parseInt(document.getElementById('skipMax').value));
                     const seq = [start, start+by, start+by*2, start+by*3, start+by*4];
                     const blankIdx = getRandomInt(1, 3); 
                     const ans = seq[blankIdx];
                     seq[blankIdx] = '____';
                     return { type: 'ns_text', q: `Fill in the blank: ${seq.join(', ')}`, ans: ans };
                } else {
                    const useExp = document.getElementById('pow_exp').checked;
                    const useMult = document.getElementById('pow_mult').checked;
                    const useDiv = document.getElementById('pow_div').checked;
                    const useDec = document.getElementById('pow_dec').checked;

                    let op = '×';
                    if (useMult && useDiv) op = Math.random() > 0.5 ? '×' : '÷';
                    else if (useDiv) op = '÷';

                    let base = getRandomInt(1, 900);
                    if(useDec) base = parseFloat((Math.random() * 100).toFixed(2));
                    
                    let power = getRandomInt(1, 3); 
                    let tenVal = Math.pow(10, power);
                    
                    let displayTen = tenVal;
                    if(useExp) displayTen = `10<sup>${power}</sup>`;

                    let ans;
                    if(op === '×') ans = base * tenVal;
                    else ans = base / tenVal;
                    
                    ans = parseFloat(ans.toFixed(4)); 

                    return { type: 'ns_text', q: `${base} ${op} ${displayTen} =`, ans: ans };
                }
            }
        }

        function formatAlgebraicAnswer(balance) {
            let terms = [];
            const r = (n) => Math.round(n * 100) / 100;
            const b = { x2: r(balance.x2), x: r(balance.x), num: r(balance.num) };

            if (b.x2 !== 0) terms.push({ coef: b.x2, var: 'x²' });
            if (b.x !== 0) terms.push({ coef: b.x, var: 'x' });
            if (b.num !== 0 || terms.length === 0) terms.push({ coef: b.num, var: '' });

            let str = "";
            terms.forEach((t, i) => {
                let val = t.coef;
                let v = t.var;
                
                if (i === 0) {
                    if (val === 1 && v) str += v;
                    else if (val === -1 && v) str += "-" + v;
                    else str += val + v;
                } else {
                    str += (val >= 0) ? " + " : " - ";
                    val = Math.abs(val);
                    if (val === 1 && v) str += v;
                    else str += val + v;
                }
            });
            return str;
        }

        function generateOrderOfOps(substMode, globalVal) {
            const termsCount = parseInt(document.getElementById('termCount').value);
            const maxVal = parseInt(document.getElementById('maxValue').value);
            const distMode = document.getElementById('distMode').value;
            const useX = document.getElementById('includeX').checked;
            const useX2 = document.getElementById('includeX2').checked;
            const useOrderFrac = document.getElementById('orderFractions').checked;
            const allowNeg = document.getElementById('allowNeg').checked;
            const hasVariables = useX || useX2;
            
            const activeOps = Array.from(document.querySelectorAll('input[name="orderOps"]:checked')).map(i => i.value);
            if (!activeOps.length) activeOps.push('+');

            let balance = { 'num': 0, 'x': 0, 'x2': 0 };
            let expression = "";
            let substitutionVal = null;

            if (substMode === 'global') {
                substitutionVal = globalVal;
            } else if (substMode === 'individual') {
                substitutionVal = Math.floor(Math.random() * 10) + 1;
            }

            const getTermType = (termStr) => {
                if (termStr.includes('x²')) return 'x2';
                if (termStr.includes('x')) return 'x';
                return 'num';
            };

            const parseVal = (termStr) => {
                let s = termStr.replace('x²','').replace('x','');
                if (s === '') return 1;
                if (s.includes('/')) {
                    const [n, d] = s.split('/');
                    return parseInt(n)/parseInt(d);
                }
                return parseFloat(s);
            };

            let doDistributive = (distMode === 'all' || (distMode === 'mixed' && Math.random() > 0.5));

            if (doDistributive) {
                let limitA = Math.max(2, Math.floor(maxVal/2));
                let a = Math.floor(Math.random() * (limitA - 1)) + 2; 

                let b = Math.floor(Math.random() * maxVal) + 1; 
                let c = Math.floor(Math.random() * maxVal) + 1; 

                let varTermType = 'num';
                if (useX2 && (Math.random() > 0.5 || !useX)) varTermType = 'x2';
                else if (useX) varTermType = 'x';

                let strB = (b === 1 && varTermType !== 'num') ? "" : b; 
                let termVar = strB + (varTermType === 'x2' ? 'x²' : (varTermType === 'x' ? 'x' : ''));
                if (varTermType === 'num') termVar = b.toString(); 

                let termConst = c.toString();

                let op = Math.random() > 0.5 ? '+' : '-';

                let isVarFirst = Math.random() > 0.5;
                let t1 = isVarFirst ? termVar : termConst;
                let t2 = isVarFirst ? termConst : termVar;

                expression = `${a}(${t1} ${op} ${t2})`;

                if (isVarFirst) {
                    balance[varTermType] += a * b;
                    if (op === '+') balance['num'] += a * c;
                    else balance['num'] -= a * c;
                } else {
                    balance['num'] += a * c;
                    if (op === '+') balance[varTermType] += a * b;
                    else balance[varTermType] -= a * b;
                }

            } else {
                const parts = [];
                let val = Math.floor(Math.random() * maxVal) + 1;
                let term = val.toString();
                if (useOrderFrac && Math.random() > 0.6) {
                    let num = Math.floor(Math.random() * val) + 1;
                    term = `${num}/${val+1}`;
                } else if(useX2 && Math.random() > 0.8) term = `${val}x²`;
                else if(useX && Math.random() > 0.6) term = `${val}x`;
                
                let type = getTermType(term);
                balance[type] += parseVal(term);
                parts.push(term);

                for(let i=1; i<termsCount; i++) {
                    let op = activeOps[Math.floor(Math.random() * activeOps.length)];
                    if (hasVariables && op !== '+' && op !== '-') {
                        op = Math.random() > 0.5 ? '+' : '-';
                    }
                    
                    let nextType = 'num';
                    if(useX2 && Math.random() > 0.8) nextType = 'x2';
                    else if(useX && Math.random() > 0.6) nextType = 'x';

                    let amt;
                    if (!allowNeg && op === '-') {
                        let currentBal = balance[nextType];
                        if (currentBal < 1) {
                            op = '+';
                            amt = Math.floor(Math.random() * maxVal) + 1;
                        } else {
                            amt = Math.floor(Math.random() * currentBal) + 1;
                        }
                    } else {
                        amt = Math.floor(Math.random() * maxVal) + 1;
                    }

                    term = amt.toString();
                    if (useOrderFrac && nextType === 'num' && Math.random() > 0.6) {
                         let num = Math.floor(Math.random() * amt) + 1;
                         term = `${num}/${amt+1}`;
                    } else {
                        if (nextType === 'x2') term += 'x²';
                        else if (nextType === 'x') term += 'x';
                    }

                    if (op === '-') balance[nextType] -= amt;
                    else if (op === '+') balance[nextType] += amt;

                    parts.push(op);
                    parts.push(term);
                }
                expression = parts.join(' ');
            }

            let answerText = "Simplify";
            let clean = expression.replace(/×/g, '*').replace(/÷/g, '/');
            let isNumeric = !clean.includes('x');
            
            if (substitutionVal !== null) {
                clean = clean.replace(/x²/g, `*${substitutionVal**2}`);
                clean = clean.replace(/x/g, `*${substitutionVal}`);
                clean = clean.replace(/(\+|-|\*|\/)\s*\*/g, '$1');
                if (clean.startsWith('*')) clean = clean.substring(1);
                clean = clean.replace(/(\d)\s*\(/g, '$1*('); 
                try {
                    const res = eval(clean);
                    answerText = Number.isInteger(res) ? res : parseFloat(res.toFixed(2));
                } catch(e) { answerText = "Err"; }
                
            } else if (isNumeric) {
                clean = clean.replace(/(\d)\s*\(/g, '$1*('); 
                try {
                    const res = eval(clean);
                    answerText = Number.isInteger(res) ? res : parseFloat(res.toFixed(2));
                } catch(e) { answerText = "Err"; }
            } else {
                answerText = formatAlgebraicAnswer(balance);
            }

            return { 
                type: 'order', 
                display: expression, 
                answer: answerText,
                subst: substitutionVal,
                isGlobalSubst: (substMode === 'global')
            };
        }

        // RENDERERS
        function renderFracUI(f) {
            if (f.type === 'whole') return `<span class="text-xl mx-1">${f.whole}</span>`;
            const wholePart = f.whole > 0 ? `<span class="text-xl mr-1">${f.whole}</span>` : "";
            return `<div class="mixed-number">${wholePart}<div class="fraction"><span class="num">${f.num}</span><span class="den">${f.den}</span></div></div>`;
        }

        function renderProblem(p, i, isKey = false, fontSizeClass) {
            const symbols = { addition: '+', subtraction: '-', multiplication: '×', division: '÷' };
            const isStacked = document.getElementById('layoutStyle').value === 'stacked';
            const isMissing = document.getElementById('modeMissing').checked;
            const missingSlot = Math.random() > 0.5 ? 1 : 2;

            let html = `<div class="problem-card"><span class="absolute top-0 left-0 text-[10px] font-bold text-gray-400">${i + 1}.</span>`;
            
            if (p.type === 'ns_compare') {
                html += `<div class="mt-4 ${fontSizeClass} font-mono whitespace-nowrap text-center w-full">
                    ${p.d1} <span class="mx-3 inline-block border-b-2 border-black w-8 text-center">${isKey ? p.ans : '&nbsp;'}</span> ${p.d2}
                </div>`;
            } else if (p.type === 'ns_order') {
                const label = p.dir === 'asc' ? "Order Least to Greatest:" : "Order Greatest to Least:";
                html += `<div class="mt-4 flex flex-wrap items-baseline gap-2 w-full">
                            <span class="text-sm font-bold text-gray-700 whitespace-nowrap">${label}</span>
                            <div class="flex-1 min-w-0 text-left">
                                <div class="${fontSizeClass} font-mono font-bold whitespace-nowrap js-order-problem-text tracking-widest text-left">
                                    ${p.items.join(' ; ')}
                                </div>
                            </div>
                        </div>`;
                if(isKey) html += `<div class="text-xs mt-1 text-[#1D546D] font-bold w-full text-left">${p.ans}</div>`;
                else html += `<div class="border-b-2 border-black w-full mt-10"></div>`;
            } else if (p.type === 'ns_forms') {
                 // Forms Problem: Simple question + answer line
                 html += `<div class="mt-4 ${fontSizeClass} font-mono whitespace-nowrap w-full text-center">
                    ${p.q} 
                    ${isKey ? `<div class="text-[#1D546D] font-bold mt-1">${p.ans}</div>` : `<div class="border-b-2 border-black w-3/4 mx-auto mt-8"></div>`}
                </div>`;
            } else if (p.type === 'ns_text') {
                 // For Rounding, we now only show the number as p.q, so we need an answer line
                 const hasAnswerLine = currentMode === 'numberSense' && document.getElementById('senseModule').value === 'rounding';
                 
                 html += `<div class="mt-4 ${fontSizeClass} font-mono whitespace-nowrap w-full text-center">
                    ${p.q} 
                    ${isKey ? `<div class="text-[#1D546D] font-bold mt-1">${p.ans}</div>` : (hasAnswerLine ? `<div class="border-b-2 border-black w-3/4 mx-auto mt-8"></div>` : '')}
                </div>`;
            } else if (p.type === 'order') {
                let problemText = p.display;
                if (p.subst !== null && !isKey && !p.isGlobalSubst) {
                    problemText += `; \xa0 x = ${p.subst}`;
                }
               html += `<div class="mt-6 ${fontSizeClass} font-mono whitespace-nowrap js-order-problem-text">${problemText}</div>`;
                if (!isKey) {
                   // =sign
                } else {
                    html += `<div class="text-right font-bold text-[#1D546D] ${fontSizeClass}">${p.answer}</div>`;
                }
            } else if (p.type === 'fraction') {
                html += `<div class="flex items-center gap-2 mt-4 ${fontSizeClass} whitespace-nowrap">${renderFracUI(p.f1)} ${symbols[p.op] || p.op} ${renderFracUI(p.f2)} = ${isKey ? `<span class="answer-text ml-2">${p.answer}</span>` : `<span class="ml-2">_______</span>`}</div>`;
            } else {
                // Standard Arithmetic
                const sym = symbols[p.op] || p.op;
                
                if (p.op === 'division' && isStacked) {
                     html += `<div class="ml-4 mt-4 ${fontSizeClass} font-mono whitespace-nowrap">
                        ${isKey ? `<span class="answer-text absolute -top-4 ml-6">${p.answer}</span>` : ''}
                        ${p.n2} <span class="border-t-2 border-l-2 border-black px-2 pt-1"> ${p.n1} </span>
                    </div>`;
                } else if (isStacked) {
                    let topDisp = p.n1, botDisp = p.n2, resDisp = isKey ? `<span class="answer-text">${p.answer}</span>` : '&nbsp;';
                    if (!isKey && isMissing) {
                        if (missingSlot === 1) topDisp = "___"; else botDisp = "___";
                    }
                    html += `<div class="math-stacked mt-4 ${fontSizeClass} whitespace-nowrap"><div>${topDisp}</div><div>${sym} ${botDisp}</div><div class="math-line"></div><div>${resDisp}</div></div>`;
                } else {
                    html += `<div class="mt-4 font-mono font-bold ${fontSizeClass} whitespace-nowrap">${p.n1} ${sym} ${p.n2} = ${isKey ? `<span class="answer-text">${p.answer}</span>` : '____'}</div>`;
                }
            }
            if (!isKey && document.getElementById('modeWord').checked && i < 4 && p.type === 'standard') {
                 html += `<div class="mt-4 text-sm italic text-gray-600 border-t pt-2">Word problem version would go here...</div>`;
            }
            return html + '</div>';
        }

        function createPageHTML(title, isAnswerKey, pageNum, colCount, globalSubstVal) {
            let substHeader = "";
            
            // Check if we are in Number Sense Forms or Rounding mode to add header instructions
            const isNumberSense = currentMode === 'numberSense';
            const nsModule = document.getElementById('senseModule').value;
            
            if (isNumberSense && !isAnswerKey) {
                let instruction = "";
                
                if (nsModule === 'forms') {
                    const task = document.getElementById('formTask').value;
                    if(task === 'expanded') instruction = "Write each number in expanded form.";
                    else if(task === 'standard') instruction = "Write each number in standard form.";
                    else if(task === 'underline') instruction = "Determine the value of the underlined digit.";
                } else if (nsModule === 'rounding') {
                    const target = parseFloat(document.querySelector('input[name="roundTarget"]:checked').value);
                    if(target === 10) instruction = "Round each number to the nearest ten.";
                    else if(target === 100) instruction = "Round each number to the nearest hundred.";
                    else if(target === 1000) instruction = "Round each number to the nearest thousand.";
                    else if(target === 1) instruction = "Round each number to the nearest whole number.";
                    else if(target === 0.1) instruction = "Round each number to the nearest tenth.";
                }
                
                if(instruction) {
                    substHeader = `<div class="text-center font-bold text-lg mt-4 text-[#1D546D] border-b-2 border-gray-300 pb-2 w-full">${instruction}</div>`;
                }
            }
            // Order of Ops substitution header (existing logic)
            else if (!isAnswerKey && globalSubstVal !== null && currentMode === 'order') {
                substHeader = `<div class="text-center font-bold text-lg mt-2 text-[#1D546D]">Evaluate each expression given x = ${globalSubstVal}</div>`;
            }

            return `
            <div class="page-container" style="transform: scale(${currentZoom})">
                <header class="text-center mb-6 border-b-2 border-teal pb-5">
                    <h1 class="worksheet-title-display text-3xl font-black heading-primary tracking-tight" 
                        contenteditable="true" 
                        data-is-key="${isAnswerKey}"
                        spellcheck="false">${isAnswerKey ? 'Answer Key - ' : ''}${title}</h1>
                    ${!isAnswerKey ? `
                    <div class="flex justify-between items-end mt-8 font-bold text-navy text-sm">
                        <div class="flex items-baseline flex-1 pr-8"><span>Name:</span><div class="header-line w-48 ml-2"></div></div>
                       
                        <div class="flex items-baseline ml-4"><span>Date:</span><div class="header-line w-24 ml-2"></div></div>
                    </div>` : `<div class="mt-4 font-bold text-navy">Page ${pageNum}</div>`}
                </header>
                ${substHeader}
                <div class="worksheet-grid problem-area mt-6" style="grid-template-columns: repeat(${colCount}, 1fr)"></div>
            </div>`;
        }

        function updatePreview() {
            ui.pageWrapper.innerHTML = '';
            const pageQty = parseInt(document.getElementById('pageQuantity').value) || 1;
            const probQty = parseInt(document.getElementById('quantity').value) || 12;
            
            // Dynamically determine column quantity based on problems per page
            let colCount;
            if (probQty <= 5) colCount = 1; 
            else if (probQty <= 10) colCount = 2; 
            else if (probQty <= 15) colCount = 3; 
            else if (probQty < 20) colCount = 4; 
            else colCount = 5; 
            
            // Overrides for Number Sense Layouts
            if (currentMode === 'numberSense') {
                 const mod = document.getElementById('senseModule').value;
                 if (mod === 'compare' && document.querySelector('input[name="compType"]:checked').value === 'order') {
                     colCount = 1; // Ordering lists needs width
                 }
                 else if (mod === 'forms' || mod === 'patterns') {
                     colCount = Math.min(colCount, 2); // Text based Qs need space
                 }
            }

            const title = ui.titleInput.value || "Mathematics Assessment";
            const activeOps = Array.from(document.querySelectorAll('#arithmeticControls input[name="ops"]:checked')).map(i => i.value);
            const substMode = document.getElementById('substMode').value;
            const distMode = document.querySelector('input[name="opDist"]:checked')?.value || 'mixed';

            let fontSizeClass = 'text-2xl'; 
            if (colCount === 2) fontSizeClass = 'text-xl';
            else if (colCount === 3) fontSizeClass = 'text-lg';
            else if (colCount >= 4) fontSizeClass = 'text-base'; 

            const allData = [];
            const globalSubstVals = [];

            if (currentMode === 'order') {
                for(let p=0; p<pageQty; p++) {
                    const pageProbs = [];
                    let globalVal = null;
                    if (substMode === 'global') globalVal = Math.floor(Math.random() * 10) + 1;
                    globalSubstVals.push(globalVal);

                    for(let i=0; i<probQty; i++) {
                        pageProbs.push(generateOrderOfOps(substMode, globalVal));
                    }
                    allData.push(pageProbs);
                }
            } else if (currentMode === 'numberSense') {
                for(let p=0; p<pageQty; p++) {
                    const pageProbs = [];
                    globalSubstVals.push(null);
                    for(let i=0; i<probQty; i++) {
                        pageProbs.push(generateNumberSenseProblem());
                    }
                    allData.push(pageProbs);
                }
            } else {
                // Arithmetic Logic
                if (distMode === 'grouped' && activeOps.length > 0) {
                    activeOps.forEach(op => {
                         for(let p=0; p<pageQty; p++) {
                            const pageProbs = [];
                            globalSubstVals.push(null); 
                            for(let i=0; i<probQty; i++) {
                                pageProbs.push(createArithmeticProblem(op));
                            }
                            allData.push(pageProbs);
                         }
                    });
                } else {
                    for(let p=0; p<pageQty; p++) {
                        const pageProbs = [];
                        globalSubstVals.push(null);
                        for(let i=0; i<probQty; i++) {
                            const op = activeOps[Math.floor(Math.random()*activeOps.length)] || 'addition';
                            pageProbs.push(createArithmeticProblem(op));
                        }
                        allData.push(pageProbs);
                    }
                }
            }

            allData.forEach((probs, pIdx) => {
                const temp = document.createElement('div');
                temp.innerHTML = createPageHTML(title, false, pIdx+1, colCount, globalSubstVals[pIdx]); 
                const page = temp.firstElementChild;
                const grid = page.querySelector('.problem-area');
                probs.forEach((p, i) => grid.innerHTML += renderProblem(p, i, false, fontSizeClass));
                if (currentMode === 'order' || (currentMode === 'numberSense')) {
                    grid.querySelectorAll('.js-order-problem-text').forEach(adjustOrderProblemFontSize);
                }
                ui.pageWrapper.appendChild(page);
            });

            if(document.getElementById('includeKey').checked) {
                allData.forEach((probs, pIdx) => {
                    const temp = document.createElement('div');
                    temp.innerHTML = createPageHTML(title, true, pIdx+1, colCount, null); 
                    const page = temp.firstElementChild;
                    const grid = page.querySelector('.problem-area');
                    probs.forEach((p, i) => grid.innerHTML += renderProblem(p, i, true, fontSizeClass));
                    if (currentMode === 'order' || (currentMode === 'numberSense')) {
                        grid.querySelectorAll('.js-order-problem-text').forEach(adjustOrderProblemFontSize);
                    }
                    ui.pageWrapper.appendChild(page);
                });
            }
            applyZoom();
            syncTitle();
        }

        function adjustOrderProblemFontSize(problemElement) {
            const parentContainer = problemElement.parentElement;
            if (!parentContainer) return;
            const containerWidth = parentContainer.clientWidth; 
            let textWidth = problemElement.scrollWidth;
            const buffer = 5;
            if (textWidth > containerWidth - buffer) { 
                let currentFontSize = parseFloat(window.getComputedStyle(problemElement).fontSize); 
                let newFontSize = currentFontSize * ((containerWidth - buffer) / textWidth); 
                newFontSize = Math.max(newFontSize, 10);
                problemElement.style.fontSize = `${newFontSize}px`; 
            }
        }
        
        window.onload = updatePreview;
    </script>
</body>
</html>